#!/bin/bash
# Modified shellos-snapshot: Create or restore Btrfs snapshots using Snapper and GRUB
# For Arch Linux systems running GRUB + snapper

COMMAND="$1"
DESC="Snapshot $(date +'%Y-%m-%d %H:%M:%S')"
SHELLOS_PATH=${SHELLOS_PATH:-$HOME/.local/share/shellos}
LOG="/var/log/shellos-snapshot.log"

log() { echo "[$(date +'%F %T')] $*" | sudo tee -a "$LOG" >/dev/null; }

if [[ -z $COMMAND ]]; then
  echo "Usage: shellos-snapshot <create|restore>" >&2
  exit 1
fi

# Ensure snapper exists
if ! command -v snapper &>/dev/null; then
  echo "Error: snapper not installed." >&2
  exit 127
fi

case "$COMMAND" in
create)
  echo -e "\e[1;32m==> Creating system snapshot...\e[0m"
  log "Starting snapshot creation"

  # Detect configs (usually root & home)
  mapfile -t CONFIGS < <(snapper --csvout list-configs | awk -F, 'NR>1 {print $1}')

  for config in "${CONFIGS[@]}"; do
    echo "→ Creating snapshot for config: $config"
    log "Creating snapshot for $config"
    sudo snapper -c "$config" create -c number -d "$DESC"
  done

  # Notify grub-btrfs daemon to update GRUB snapshot menu
  if systemctl is-active --quiet grub-btrfsd.service; then
    echo "→ Updating GRUB snapshot entries..."
    sudo systemctl restart grub-btrfsd.service
    log "Triggered grub-btrfsd restart"
  fi

  echo -e "\e[1;32mSnapshot created successfully. Boot menu updated.\e[0m"
  log "Snapshots created successfully"
  ;;

restore)
  echo -e "\e[1;33m==> Restoring a snapshot...\e[0m"

  # Pick config (if multiple exist)
  mapfile -t CONFIGS < <(snapper --csvout list-configs | awk -F, 'NR>1 {print $1}')
  if [[ ${#CONFIGS[@]} -gt 1 ]]; then
    if command -v gum &>/dev/null; then
      CONFIG=$(printf "%s\n" "${CONFIGS[@]}" | gum choose --header "Select Snapper config")
    else
      echo "Available configs: ${CONFIGS[*]}"
      read -p "Enter config name: " CONFIG
    fi
  else
    CONFIG="${CONFIGS[0]}"
  fi

  # Show snapshots
  mapfile -t SNAPSHOTS < <(snapper -c "$CONFIG" list | awk 'NR>2 {print $1" - "$5" ("$3")"}')
  if [[ ${#SNAPSHOTS[@]} -eq 0 ]]; then
    echo "No snapshots found."
    exit 1
  fi

  if command -v gum &>/dev/null; then
    CHOICE=$(printf "%s\n" "${SNAPSHOTS[@]}" | gum choose --header "Select snapshot to restore")
  else
    printf "%s\n" "${SNAPSHOTS[@]}"
    read -p "Enter snapshot number: " SNAP_NUM
    CHOICE="$SNAP_NUM"
  fi

  SNAP_ID=$(echo "$CHOICE" | awk '{print $1}')
  echo -e "\e[1;33m→ Rolling back to snapshot #$SNAP_ID...\e[0m"
  log "Selected snapshot $SNAP_ID for config $CONFIG"

  # Confirm
  if command -v gum &>/dev/null; then
    gum confirm "This will replace your current system with snapshot #$SNAP_ID. Continue?" || exit 0
  else
    read -p "Confirm rollback (y/N): " CONFIRM
    [[ "$CONFIRM" =~ ^[Yy]$ ]] || exit 0
  fi

  # Execute rollback
  sudo snapper -c "$CONFIG" rollback "$SNAP_ID"
  log "snapper rollback executed for $CONFIG snapshot $SNAP_ID"

  # Set new rollback snapshot as default
  NEW_ID=$(sudo btrfs subvolume get-default / | awk '{print $NF}')
  echo "→ Setting subvolume $NEW_ID as default..."
  sudo btrfs subvolume set-default "$NEW_ID" /
  log "Set Btrfs default subvolume to $NEW_ID"

  echo "→ Rebuilding initramfs & updating GRUB..."
  sudo mkinitcpio -P
  sudo grub-mkconfig -o /boot/grub/grub.cfg
  log "Rebuilt initramfs + grub config"

  echo -e "\e[1;32mRollback complete.\e[0m"
  echo "Reboot to apply changes."
  log "Rollback finished successfully"
  ;;

*)
  echo "Invalid command: $COMMAND"
  echo "Usage: shellos-snapshot <create|restore>"
  exit 1
  ;;
esac