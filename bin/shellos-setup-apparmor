#!/bin/bash

set -e

GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

print_success() {
  echo -e "${GREEN}$1${NC}"
}

print_error() {
  echo -e "${RED}$1${NC}"
}

print_info() {
  echo -e "${YELLOW}$1${NC}"
}

check_grub() {
  # GRUB is present if /etc/default/grub exists
  if [[ ! -f /etc/default/grub ]]; then
    print_error "No GRUB installation detected. Manual kernel parameter configuration required."
    return 1
  fi
  return 0
}

print_info "=== Deploying AppArmor Enablement Stack ==="
sudo pacman -S --needed --noconfirm apparmor audit
sudo systemctl enable --now apparmor.service
print_success "AppArmor installed and service enabled."

if check_grub; then
    current=$(grep "^GRUB_CMDLINE_LINUX_DEFAULT" /etc/default/grub | cut -d'"' -f2)
    new="$current"

    # Ensure the required parameters are appended once
    [[ ! "$current" =~ lsm= ]] && new="$new lsm=landlock,lockdown,yama,apparmor,bpf"
    [[ ! "$current" =~ apparmor=1 ]] && new="$new apparmor=1"
    [[ ! "$current" =~ security=apparmor ]] && new="$new security=apparmor"

    # Trim leading/trailing whitespace
    new=$(echo "$new" | xargs)

    if [[ "$new" != "$current" ]]; then
        sudo sed -i "s|^GRUB_CMDLINE_LINUX_DEFAULT.*|GRUB_CMDLINE_LINUX_DEFAULT=\"$new\"|" /etc/default/grub
        sudo grub-mkconfig -o /boot/grub/grub.cfg
        print_success "GRUB updated with AppArmor and LSM parameters. Reboot required to activate."
    else
        print_info "No GRUB updates needed â€” parameters already aligned with policy."
    fi
else
    print_info "Proceeding without GRUB automation. Add the following to your kernel parameters manually:"
    echo -e "\n  lsm=landlock,lockdown,yama,apparmor,bpf apparmor=1 security=apparmor\n"
fi

